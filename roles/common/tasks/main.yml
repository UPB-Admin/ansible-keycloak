- name: Install packages and set up host entries
  become: yes
  block:
    - name: Install EPEL Release package repository
      package:
        name: epel-release
        state: latest

    - name: Install common system packages
      package:
        name:
          - acl
          - chrony
          - firewalld
          - gzip
          - python3
          - python3-libsemanage
          - python3-pyOpenSSL
          - rsync
          - tar
          - unzip
          - vim
          - zip
        state: latest

    - name: Add hosts entries
      lineinfile:
        path: /etc/hosts
        state: present
        regexp: "{{ item.name }}"
        line: "{{ item.ip }} {{ item.name }}"
      loop_control:
        label: "{{ item.name }} -> {{ item.ip }}"
      with_items: "{{ groups.all | map('extract', hostvars) | list | json_query('[*].{ name: inventory_hostname, ip: interfaces_internal_ip }') }}"


- name: Firewalld common configurations
  become: yes
  block:
    - name: Ensure firewalld is started and enabled
      systemd:
        name: firewalld
        state: started
        enabled: yes

    - name: Configure internal interface firewall zone
      include_tasks: configure_firewall_zone.yml
      with_items:
        - name: "{{ firewalld_internal_zone }}"
          interfaces: [ "{{ interfaces_internal_name }}" ]
          services:
            - { name: ssh, enabled: yes }
      loop_control:
        loop_var: zone

    - name: Configure external interface firewall zone (if different from internal interface)
      when: firewalld_has_external
      include_tasks: configure_firewall_zone.yml
      with_items:
        - name: "{{ firewalld_dmz_zone }}"
          interfaces: [ "{{ interfaces_external_name }}" ]
          services:
            - { name: ssh, enabled: no }
      loop_control:
        loop_var: zone

    - name: Move loopback interface to trusted chain
      firewalld:
        zone: trusted
        interface: lo
        permanent: yes
        immediate: yes
        state: enabled


- name: Configure service for NTP synchronization
  become: yes
  block:
    - name: Copy chrony configuration template
      template:
        src: chrony.conf
        dest: /etc/chrony.conf
        mode: 0644
        owner: root
        group: root
      notify: restart chronyd

    - name: Make sure chrony is started and enabled
      service:
        name: chronyd
        state: started
        enabled: yes


- name: Set system journal persistency to persistent
  become: yes
  ini_file:
    path: /etc/systemd/journald.conf
    section: Journal
    option: Storage
    value: persistent
    state: present
  notify: restart systemd-journald


- name: Clean Keycloak path prefix variable (ensure it has a leading slash)
  set_fact:
    keycloak_path_prefix: "/{{ keycloak_path_prefix | regex_replace('/+', '/') | regex_replace('^/|/$', '') }}"
