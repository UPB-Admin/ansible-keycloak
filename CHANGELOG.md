## Changelog

### February 2026
- Refactor PKI generation to allow creating multiple certificates for the same
  service (e.g., the load balancer has a certificate for requests to the
  service's public hostname, as well as a dummy certificate that is used for any
  other request). Also includes some minor refactoring to how other roles use
  certificates to align with the new changes and improve usage of PKI-related
  variables.

- Bump Keycloak to version 26.5.3.

- Enable MDC (Mapped Diagnostic Context) extra information to Keycloak logs.

- Add variable to control whether the playbook should remove unexpected firewall
  rules. It defaults to True, but may be disabled to prevent removing firewall
  rules configured outside the playbooks.

- Fix parsing of existing rich rules - tools like `fail2ban` may add rules to
  reject traffic, where the rich rules may contain a `type="..."` component
  after the `reject` action string.

- Add a task to configure custom entries to `/etc/hosts`.

- Move database creation tasks later in the database playbook. This allows
  applying configuration changes and restarting the database before attempting
  to perform any updates on the database. The previous order attempted
  to perform database operations without applying possible configuration fixes,
  causing the playbook to always fail if the database could not start
  because of a bad configuration.

- Unify MariaDB's Galera configuration files. The only difference between the
  two files was the `wsrep_cluster_address` variable, where the slave nodes only
  had the master's address configured (instead of the addresses of all the nodes
  in the cluster), but this difference does not appear necessary.

- Fix MariaDB Galera cluster communications encryption. Previously only the SST
  traffic, which was being directed through `stunnel` was encrypted, however, it
  also did not correctly use PKI to verify the peer's identity. We now use
  PKI certificates for the `stunnel` connection and encrypt other cluster
  traffic by configuring the `wsrep_provider_options` setting.

- Update LDAP commands to use binaries' full paths.

- Add condition to replace self-signed certificates if they do not contain the
  `CA:TRUE` basic constraint. Without this constraint some services could refuse
  to accept them as CA certificates.

- Add tasks to control LDAP's number of PBKDF2 password hashing iterations.

- Configure LDAP to use the certificates generated by the PKI role. Previously
  the service used a different set of certificates, which were created when the
  instance was initially configured.

- Add the LDAP certificate to Keycloak's trust stores to allow configuring
  connections via the `ldaps` protocol.

- Adjust sysctl variables for the load balancer - increase the values of max PID
  and max connections and configure a reasonably large conntrack limit - without
  this setting the system may drop connections in high stress settings.

- Show certificate sign request information if the rsyslog private key is
  (re)generated by the playbook, even if a certificate is already configured in
  the variables, since the value cannot correct for a different private key.

- Make sure the database is started before running MySQL queries.

- Bump Infinispan to version 15.0.22.

- Remove Prometheus exporter archives after installation.

- Configure TLS for Infinispan clustering TCP connections to encrypt all
  cross-site communications.

- Use absolute paths (i.e., the Ansible variables) for Infinispan log
  configurations. This removes the need to manually synchronize the Ansible
  variables with the values in the configuration file.

- Do not update the `java` and `javac` commands globally when installing a new
  version. Instead, define a variable to the location of the "Java home"
  directory and use it to configure the `JAVA_HOME` environment variable in the
  systemd service files. The previous approach did not allow using multiple
  versions of Java at the same time, since all services used the default `java`
  binary defined by `update-alternatives`. Note that this may leave the
  `/usr/bin/java` and `/usr/bin/javac` links broken since they are no longer
  updated by the playbook (the package installation scripts may still update
  them, however). If that is the case and you need any of the commands
  globally, use the `update-alternatives` command to fix the links.

### November 2025
- Bump Keycloak to version 26.4.2.

### July 2025
- Set absolute path for Python 3 interpreter in `ansible.cfg`. Using `auto`
  caused Ansible to display warnings on every run. Note that this can also
  result in having to manually install the `python3` package on the system prior
  to running the playbook for the first time.

- Bump Keycloak to version 26.3.1 and Infinispan to version 15.0.16 (aligned
  with the version used by Keycloak).

- Roll back (remove) `expand_argument_vars` argument from `command` tasks as
  this functionality may not be available on older versions of Ansible.

### June 2025
- Add `expand_argument_vars: false` to all `command` tasks to avoid any
  accidental variable expansions.

- Verify Keycloak downloads using the GPG signing key (available at
  https://www.keycloak.org/keys - link available from the Downloads page)
  instead of the SHA1 checksum. This approach provides a higher level of trust
  and removes the need to update the checksum manually for every update.

- Bump Keycloak to version 26.2.5.

- Add checks for passwords in the vault - make sure the passwords have been
  updated (i.e., the "changeme" placeholder has been replaced everywhere) and
  the passwords do not contain some special characters that could cause
  issues in specific circumstances. Even with these restrictions, long
  (over 30 characters) random passwords should provide adequate security.

### May 2025

- Configure the certificates to have the `CA: true` basic constraint and add the
  "basic constraints critical" setting. This is the same behavior as
  `openssl req -x509` and is a reasonable default for self-signed
  certificates. The `CA: true` basic constraint is required by the
  `update-ca-trust` command (according to this Stack Exchange post:
  https://unix.stackexchange.com/a/599944); otherwise, the certificate is not
  added to the certificate bundle. This is especially relevant for the load
  balancers' certificate, to allow clients to trust it at system level.
  **NOTE**: applying this change will restart all services, as their
  certificates change and the services must reload the certificates.

- Add health checks (check if TCP ports respond) to the Infinispan and Keycloak
  systemd service files. Also remove the `PIDFile` parameter from Keycloak's
  service file as the service does not create the PID file, and using it in
  conjunction with the `ExecStartPost` command makes systemd believe the
  service start fails.

- Fix a typo in the Keycloak configuration file that sets the minimum database
  connection pool size.

- Bump Keycloak to version 26.2.2 and Infinispan to version 15.0.14 (aligned
  with the version used by Keycloak). Also update the download URL template for
  Infinispan to GitHub releases.

- Configure more restrictive permissions for the mysqld exporter, based on the
  [issue #622](https://github.com/prometheus/mysqld_exporter/issues/622) from
  their GitHub repository.

- Update the Prometheus exporters to their latest version. **NOTE**: the HAProxy
  exporter has been retired for some time, as HAProxy natively supports
  Prometheus compatible metrics. The service will eventually be removed and,
  if the option is available using the regular HAProxy binaries, metrics will be
  enabled in the HAProxy service.

- Add instructions to configure Infinispan cross-site replication alerts
  in Prometheus. The information is added in the configuration file of the nginx
  server configured to filter requests to the `/metrics` endpoint.

- Bump Keycloak to version 26.2.3.


### January 2025
- Add configuration option to ignore dangling lock files in Infinispan
  persistence directory after an unclean service shutdown.
  Not setting this option results in Infinispan refusing to start if the service
  was not cleanly shut down before.

- Add option to log audit events to the log file, besides the databases
  (defaults to true).

- Upgrade Keycloak to 26.0.7. This Keycloak version changes how communication to
  the external Infinispan server is configured (i.e., remote Infinispan servers
  are defined as variables in the Keycloak configuration file, instead of the
  `cache-ispn.xml` file, which has been removed). Other parameters, such as
  serialization protocol to Infinispan have also been changed.

- Also update Infinispan to version 15.0.11.Final to be in lockstep with the
  version used by Keycloak internally.

- Update environment variables for initial (bootstrap) Keycloak administrator
  account.

- Add rule to remove Infinispan persistence directory and restart Infinispan
  when upgrading Keycloak from a version earlier than 26; this is required since
  the marshalling protocol has changed to Infinispan Protostream, and is
  incompatible with the old JBoss Marshalling encoding. The variable used to
  keep track of the latest installed Keycloak version has been renamed to
  improve readability with this occasion.

- Add a "stop" rule to end parsing the data from the services in rsyslog.
  Without this rule, the lines from the Keycloak and Infinispan log files were
  also handled by the other rsyslog rules, which could copy the data to some
  other locations (e.g., the `/var/log/messages` file).

- Slightly improve rsyslog parsing by excluding empty rules (e.g., on a system
  running only LDAP, a `re_match($syslogtag, '^()$')` rule was added
  unnecessarily).

- Change logging configurations to only log success audit events to the `file`
  logger if all audit logs are logged. This is done by configuring the log level
  of the `org.keycloak.events` to `debug` if logging is enabled, which means
  that the events are logged by the `file` logger (since its log level is set to
  `debug` to capture all events of `debug` level or higher), but not the
  `console` logger (since its level is set to `info`, which is higher).

- Bump Keycloak to version 26.1.0.

- Remove Keycloak truststore password from the example vault file, as Keycloak
  can import certificates directly (in PEM format), without a truststore.
  If already defined, removing the password from the production vault is not
  required, since the value is simply not used by the playbook.

- Change check in LDAP playbook to allow installation on RedHat-based systems,
  not just CentOS; fail if the system is not RedHat-based, however.

### September 2024
- Bump Keycloak to version 25.0.6.

### August 2024
- Configure firewall port in NetworkManager configuration file. Starting with
  RHEL 9 the configuration using network-scripts has been deprecated, and
  replaced with NetworkManager configuration scripts.

- Add MariaDB and Infinispan services to the "After=" section in the Keycloak
  service file. This will make Keycloak wait for both services to finish
  starting before attempting to start itself (only works if services are
  hosted on the same node).

- Increase rsyslog message maximum size.

- Upgrade Keycloak to version 25.0.2 and Infinispan to version 15.0.5.
  This is a large change that introduces multiple changes: Keycloak now
  supports persisting user sessions in the database as an experimental
  feature. We have enabled this feature by default; consequently, Infinispan
  persistence to the database has been removed and replaced with a local
  file storage persistence.

  Various other changes have been introduced as requirements for the upgrade:
  a new management port has been added to Keycloak and is exposed to the
  reverse proxy on port 9001, Java has been bumped to version 21, Infinispan
  cache configurations have been updated, Keycloak HotRod marshalling has been
  removed, Infinispan role mappings are explicitly set in the
  `groups.properties` file, the `MONITOR` role has been added for the Keycloak
  user in Infinispan.

  **NOTE**: The upgrade removes Infinispan persistence to the database; all
  existing user sessions from before the upgrade will be lost.

  **NOTE**: The playbook does not remove the database used for Infinispan
  persistence. After upgrading and confirming that everything works as
  expected, you can safely drop the `infinispan` database.

- Move Keycloak and Infinispan logs to `/var/log/keycloak` and
  `/var/log/infinispan`, respectively. This is required to allow rsyslog to
  track the log files using the `imfile` module (in `inotify` mode).
  Inotify is blocked by SELinux for normal files.

- Improve rsyslog processing of logs by also reading logs from files.
  This allows us to configure Keycloak and Infinispan to log in JSON format
  for easier parsing, without changing the format of the logs in the journal.
  Logging is configured at role level, instead of globally, which means that
  only the services installed on the system have associated rules in the
  rsyslog file. It is also possible to define additional custom logging from
  either the journal or files.

- Add some security rules to Keycloak and Infinispan systemd services.

- Use the more modern `RSYSLOG_ForwardFormat` template that sends more precise
  timestamp information, as well as the timezone offset information.

- Bump Keycloak to version 25.0.4.


### June 2024
- Fix typo in Infinispan backup configurations.

- Add optional configurations for mTLS rsyslog. The playbook only generates
  the private key and certificate sign request, but does not (as it cannot)
  automatically sign the CSR to generate a certificate. This means that the
  playbook must be run twice - once to generate the certificate sign request,
  and a second time to configure the certificate and restart rsyslog.

- Add SELinux port configurations for rsyslog, to allow connecting to
  non-standard syslog ports.


### May 2024
- Bump Keycloak version to 24.0.4


### March 2024
- Bump Keycloak version to 23.0.7.


### February 2024
- Bump Keycloak version to 23.0.6.

- Increase timeouts for remote store connections in Keycloak.

- Disable MariaDB performance schema by default to reduce the database's
  memory footprint. It can be re-enabled if required.

- Redo memory allocation calculations. The new calculations should be more
  fair for each service when multiple services run on the same system.
  Keycloak and Infinispan heap size is capped at 4GB, which should be enough
  for smaller deployments with up to 600 000 user sessions. Also, deploying
  Keycloak or Infinispan on servers with less than 2GB of RAM will fail, since
  we expect at least 768MB of RAM reserved for system overhead, and 1280MB of
  RAM for the service. This is a conservative estimate.

  **NOTE**: The memory cap of 4GB is only applied if both Java and non-Java
  services run on the same server. Otherwise, Java services should be able to
  use almost all available memory. This limit can be controlled using the
  `java_shared_system_mem_max` variable.


### January 2024
- Change Keycloak embedded Infinispan JGroups stack to use a non default TCP
  port. This should allow hosting a dedicated Infinispan instance on the same
  node as Keycloak. Also changed the discovery mechanism to TCPPING
  (without initial hosts, functionally disabled), MPING could also conflict
  with the Infinispan service.

- Bump Keycloak version to 23.0.3.

- Add utility `cluster_servers` dictionary variable with lists of nodes that
  with each type of service in the cluster.

- Use same version of Java for both Infinispan and Keycloak. If multiple
  versions of Java would be used, it would cause the Ansible playbooks to
  override the alternatives when both Infinispan and Keycloak are hosted on
  the same node. This change also upgrades Infinispan to Java 17.

- Update PKI generation to correctly create PKI files for all services running
  on a single node.

- Update rsyslog configurations to catch the logs sent to syslog by all
  services installed by the playbook.

- Update memory allocation for Java services if multiple services run on the
  same system.


### December 2023
- Update the playbook files to work with Centos 9 (and newer package versions
  available on Centos 9).

- Update node and mysqld exporter versions.

- Move firewall configurations to dedicated role.


### July 2023
- The database (MariaDB) systemd overrides file has been renamed to
  `overrides.conf` to reflect that more than just file number limit can be
  changed.

- Database error logs have been moved to the journal, instead of the
  `/var/log` directory. This aligns the logging mechanism with the rest of the
  services.

- Added the rsyslog role that allows sending logs to remote log servers. The
  logs can be sent as either plain-text data or encrypted using TLS.


### June 2023
- Keycloak was upgraded to version 21.1.2.


### March 2023
- Set a proper name for Infinispan and Keycloak services in syslog.

- Keycloak was updated to version 21.0.1.

- Infinispan was updated to version 14.0.7.

- Infinispan cross-datacenter timeout parameters were changed to allow more
  leeway in high contention scenarios and short network interrupts.

- Added access to Infinispan metrics endpoint for Prometheus servers.

- Set proper names for Keycloak nodes for session stickyness.

- Updated nginx load balancing based on `AUTH_SESSION_ID` cookie, instead of
  just the source IP address.

- Tweaked Galera configuration.

- Moved Infinispan persistence to a different database, based on cluster
  names. Note that this will increase the database usage.


### January 2023
- Keycloak was updated to version 20.0.3.

- Infinispan was updated to version 13.0.13.

- Infinispan persistence was changed to JDBC, storing the caches in a shared
  database inside the MariaDB cluster. This allows switching Infinispan
  versions without losing the local persistence data that was previously
  stored in a local (per-instance and per-version) RocksDB database.

- Configured Keycloak to use the IP addresses of Infinispan instances, instead
  of hostnames. Using the hostname (from the Ansible inventory file) made
  Keycloak confused about the identities of the Infinispan servers it
  connected to, since Infinispan sent the IP address as the identifier, while
  Keycloak expected the servers to match their hostnames.


### December 2022
- the EPEL modules are being deprecated (including the `epel-modulear`
  repository). The repository has been forcibly enabled, but will likely need
  to be removed in the future.

- updated the nginx configuration to use stopping regex matches for location
  blocks (i.e. using the `~` modifier instead of the default (None) modifier).
  This is meant to increase matching precision, as the default modifier matches
  the longest described match of any `location`. An explanation of `location`
  blocks can be found on [Stack Overflow](https://stackoverflow.com/a/59846239).

- access to the entire master realm has been limited using the same ACL that
  limits access to the admin console. This was necessary because despite not
  being able to access the admin console, an attacker could still attempt to
  attack the realm's login page.
